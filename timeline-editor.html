<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Data2Image</title>
		<script type="text/javascript" src="build/Data2Image.min.js"></script>
		<script type="text/javascript" src="https://rawgit.com/zz85/timeliner/master/timeliner.js"></script>
		<script type="text/javascript" src="https://rawgit.com/patriciogonzalezvivo/glslCanvas/master/build/GlslCanvas.min.js"></script>
		<link type="text/css" rel="stylesheet" href="https://rawgit.com/patriciogonzalezvivo/glslEditor/gh-pages/build/css/main.css">
    	<script type="application/javascript" src="https://rawgit.com/patriciogonzalezvivo/glslEditor/gh-pages/build/js/glslEditor.js"></script>
		<style type="text/css">
		body {
			font-family: Helvetica, Arial, sans-serif;
			color: white;
			margin: 0;
  			background: #272822;
		}

		#controls {
			display: inline;
		}

		.control_element {
			display: inline;
		}

		#shader {
			width: 500px;
			height: 500px;
			margin-left: auto;
    		margin-right: auto;
		}
		#container {
			width: 100%;
			text-align: center;
		}
		#glsl_editor {
			height: 100%;
		}
		</style>
	</head>
	<body>
		<ul id="controls">
			<li class="control_element"> Fps: 1/<input type="number" id="fps" value="24"> </li>
			<li class="control_element"> <button type="button" onclick="generateTable()">Regenerate table</button> </li>
		</ul>
		<div id='glsl_editor'></div>
		
		<script type="text/javascript">
			var data;
			var timeliner = new Timeliner();
			var duration = 30;
			var fps = 1;
			var totalInstances = 0;
			var step = 1/fps;
			var frames = [];
			var glslEditor = null;
			reloadTimeline();
			generateTable();

			function fetchHTTP(url, methood){
	            var request = new XMLHttpRequest(), response;

	            request.onreadystatechange = function () {
	                if (request.readyState === 4 && request.status === 200) {
	                    response = request.responseText;
	                }
	            }
	            request.open(methood ? methood : 'GET', url, false);
	            request.send();
	            return response;
	        }

			function reloadTimeline () {
				// timeliner.load({
				// 	"version":"1.4.0",
				// 	"modified":"Mon Dec 08 2014 10:41:11 GMT+0800 (SGT)",
				// 	"title":"Untitled",
				// 	"name":"simple",
				// 	"totalTime": 10,
				// 	"layers":[],
				// 	"ui":{
				// 		"currentTime":0,
				// 		"totalTime": duration,
				// 		"scrollTime":0,
				// 		"timeScale":40
				// 	}
				// });
				var file = fetchHTTP('timeliner-test.json');
				timeliner.load(JSON.parse(file));
			}

			function getFps() {
				return document.getElementById("fps").value;
			}

			function generateTable() {
				data = new Data2Image();
				fps = document.getElementById("fps").value;
				totalInstances = Math.floor(duration*fps)
				_data.setValue('ui:currentTime',duration/2)
				frames = timeliner.getValues(totalInstances/2,duration/totalInstances);
				console.log("Ready to generate " + totalInstances + " instances");

				data.setTotalInstances(totalInstances);
				if (frames) {
					for (var element in frames[0]) {
						data.addElement(element, 'number', (instance, element) => {
							var value = frames[instance][element.name];
							return parseFloat(value.toFixed(3));
						});
					}
				}

				if (!glslEditor) {
					glslEditor = new GlslEditor('#glsl_editor', { 
			    		canvas_size: 500,
			    		// canvas_follow: true,
			            // divider: true,
			    		theme: 'monokai',
			    		multipleBuffers: true,
			            watchHash: true,
			            fileDrops: true,
			    		menu: true
			    	});
					glslEditor.open('shader.frag');
				}
				glslEditor.sandbox.canvas.loadTexture('u_tex0',data.generate(),{filtering: 'nearest'});
			}
		</script>
	</body>
</html>